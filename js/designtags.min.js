var tagged;var spinner;jQuery(document).ready(function(b){if(b(".admin-bar").length>0){load_tag_button()}if(designtag_vars.wcpt_preload==1){reset_tags()}else{get_all_designtags(jQuery(".tag_autoload"),false)}if(jQuery("div#wcpt-featured-products-inner").length){jQuery("div#wcpt-featured-products").append(jQuery("div#wcpt-featured-products-inner").html())}jQuery(".wcpt-article").mouseenter(function(){jQuery(this).children(".wcpt-post-title").fadeIn()});jQuery(".wcpt-article").mouseleave(function(){jQuery(this).children(".wcpt-post-title").fadeOut()});jQuery(document).on("click","#tag_form #tag_save",function(f){var d=this;tagged.image_tag.set_original(jQuery("#chk_original:checked").val());tagged.image_tag.set_description(jQuery("#txt-description").val());console.log("saving tag for "+tagged.tagged_obj.id);jQuery(this).prop("disabled",true);jQuery(this).val("saving...");tagged.save(function(e){if(e.successful){jQuery(d).val("Saved successfully");jQuery("#tag_form #tag_cancel").hide();jQuery("#tag_form").delay(500).fadeOut(200);jQuery("#tag_form #tag_cancel").show();var g=Math.round(tagged.image_tag.pos_y-tagged.image_tag.height/2)+"px";var h=Math.round(tagged.image_tag.pos_x-tagged.image_tag.width/2)+"px";tagged.image_tag.ratio_x=e.data.tag_position.ratio_x;tagged.image_tag.ratio_y=e.data.tag_position.ratio_y;tagged.image_tag.pos_x=e.data.tag_position.tag_x;tagged.image_tag.pos_y=e.data.tag_position.tag_y;tagged.image_tag.id=e.data.tag_id;tagged.set_html(e.data.html);jQuery("body").append(e.data.html);reset_tags()}else{alert("Save failed");jQuery(d).val("Save");jQuery(this).prop("disabled",false)}})});jQuery(document).on("click","#tag_form #tag_cancel",function(d){jQuery("#tag_form").fadeOut(200)});jQuery(document).on("click","#tag-products-layer .close-modal.x-black",function(d){b("#tag-products-layer").animate({left:"-20%"},1000,function(){b("#tagtool-tab").show()});jQuery("body").removeClass("tagtool");reset_tags()});jQuery(document).on("click",".tagtool-section.products",function(d){jQuery(".tagtool-product-list").toggle();jQuery(".tagtool-user-list").toggle()});jQuery("#tagtool-tab").click(function(d){d.preventDefault();jQuery("body:not(.tagtool)").addClass("tagtool");if(b("#tag-products-layer").length){b("#tag-products-layer").show();b("#tag-products-layer").animate({left:"0"},1000);b("#tagtool-tab").hide();reset_tags();init_tagging()}else{c()}});jQuery(document).on("click","#tag-products-layer a.page-numbers",function(h){h.preventDefault();var g="";var f=b("#tag-products-layer #cat").val();if(jQuery(this).is("a.page-numbers")){var d=jQuery(this).attr("href");g=getUrlParameter(d,"product-page")}var i=b("#tag-search").val();a(f,i,g)});jQuery("#tag-products-layer #tagtool-filter").click(function(){var d=b("#tag-products-layer #cat").val();var e=b("#tag-products-layer #tag-search").val();a(d,e,1)});function c(d){b.ajax({url:designtag_vars.ajax_url,data:{action:"wcpt_tag_panel_output","product-page":d}}).done(function(e){b("body").append(e);jQuery("#tag-products-layer").show();reset_tags();init_draggable();init_droppable();jQuery(".product-simple img").each(function(){var f=jQuery(this).offset().height});jQuery(document).on("mouseenter",".draggable",function(){if(!jQuery(this).hasClass("ui-draggable")){init_draggable()}})}).fail(function(f,e,g){alert("There was an error loading the tool: "+e+" : "+g)})}function a(d,f,e){b.ajax({url:designtag_vars.ajax_url,data:{action:"wcpt_tagtool_product_search","product-page":e,cats:d,"tag-search":f}}).done(function(g){b("#tagtool-product-results").empty();b("#tagtool-product-results").append(g);jQuery("#tag-products-layer").show();reset_tags();init_draggable();init_droppable();jQuery(".product-simple img").each(function(){var h=jQuery(this).offset().height});jQuery(document).on("mouseenter",".draggable",function(){if(!jQuery(this).hasClass("ui-draggable")){init_draggable()}})}).fail(function(h,g,i){alert("There was an error loading the tool: "+g+" : "+i)})}jQuery(document).on("mouseenter click","li.designtag",function(i){var h=9;if(jQuery(this).attr("id").match("_z")){h=1501}jQuery(this).css("z-index",h);jQuery(this).children(".ft_msg").show();jQuery(this).children("i.designtag").hide();var d="C_"+jQuery(this).data("author-login");var f=jQuery(this).data("author-name");var g=jQuery(this).data("type");var k=jQuery(this).data("id");var j=jQuery(this).data("title");if(designtag_vars.wcpt_ga==1){ga("send","event","Woocommerce Photo Tag","Tag View",j)}i.stopPropagation()});jQuery(document).on("mouseleave","li.designtag",function(){var d=8;if(jQuery(this).attr("id").match("_z")){d=1501}jQuery(this).children(".ft_msg").hide();jQuery(this).children("i.designtag").show();jQuery(this).css({"z-index":d})});jQuery(document).on("click",".ft_msg a",function(d){var f=jQuery(this).parents("li.designtag").data("title");ga("send","event","Woocommerce Photo Tag","Product View",f)});jQuery(document).on("click","#tag_form #chk_original",function(){if(jQuery(this).prop("checked")){jQuery("#tag_form i").addClass("designtag");jQuery("#tag_form i").removeClass("suggestion")}else{jQuery("#tag_form i").addClass("suggestion");jQuery("#tag_form i").removeClass("designtag")}});jQuery(window).resize(function(){reset_tags()});jQuery(".single-product .tabs a").click(function(d){jQuery("li.designtag").hide();if(jQuery(this).attr("href")=="#tab-wcpt"){window.setTimeout("reset_tags()",100)}})});jQuery(document).ajaxStart(function(){spin(true)});jQuery(document).ajaxStop(function(){init_draggable();spin(false)});function reset_tags(){jQuery("li.designtag").each(function(){render_wcpt(jQuery(this))});enable_delete_tag()}function enable_delete_tag(){jQuery(".delete-tag").click(function(a){a.preventDefault();var b=jQuery(this).data("tag_id");if(confirm("Are you sure?")){delete_designtag(b,function(c){if(!c.success){alert(c.message)}})}a.stopPropagation()})}function init_tagging(){init_draggable();init_droppable()}function init_draggable(){jQuery(".product-simple.draggable,.tagtool-user.draggable,.product-image-div").draggable({opacity:0.9,helper:"clone",cursor:"pointer",appendTo:"#main",cursorAt:{top:-5,left:-5},start:function(a,b){jQuery(b.helper).addClass("ui-draggable-helper")}})}function init_droppable(){console.log("droppable initiated");jQuery(".droppable").droppable({accept:".product-simple.draggable,.tagtool-user.draggable",hoverClass:"ui-droppable-hover",tolerance:"pointer",drop:function(a,h){var g=h.offset.top-jQuery(this).offset().top-5;var i=h.offset.left-jQuery(this).offset().left-5;console.log("dropped:"+h.draggable.attr("id"));var b=h.draggable.attr("id");var f=(b.match(/user/))?"user":"product";var d;if(f=="product"){var c=b;jQuery("#tag_form .fa-tag").show();jQuery("#tag_form .fa-user").hide();d=new product(c,"");jQuery("#tag_form #tag_form_img").attr("src",jQuery(".product-simple.draggable#"+c+" img").attr("src"))}else{if(f=="user"){jQuery("#tag_form #tag_form_img").attr("src",jQuery(".tagtool-user.draggable#"+b+" img").attr("src"));jQuery("#tag_form .fa-user").show();jQuery("#tag_form .fa-tag").hide();jQuery("#tag_form #original-product").hide();var j=h.draggable.attr("id");jQuery("#tag_form .fa-user").show();jQuery("#tag_form .fa-tag").hide();var e=jQuery(h.draggable.helper).find(".tagtool-user-link").text();d=new user(j,e,"","")}}var k=new tag("",i,g,20,20,20,20);tagged=new Designtag("",jQuery(this),k,d,jQuery(this).data("wcpt_image_id"));jQuery("body").prepend(jQuery("#tag_form"));jQuery("#tag_form").css({top:h.offset.top,left:h.offset.left});jQuery("#tag_form #tag_save").prop("disabled",false);jQuery("#tag_form #tag_save").val("Save");jQuery("#tag_form").fadeIn(200)},})}function tag(b,a,i,j,h,c,g,d,e,f){this.id=b;this.pos_x=a;this.pos_y=i;this.ratio_x=j;this.ratio_y=h;this.width=c;this.height=g;this.original=d;this.description=f;this.html=e;this.set_original=function(k){this.original=k};this.set_description=function(k){this.description=k}}function product(a,b){this.id=a;this.tagged_type="product";this.variation_id=b}function Designtag(f,a,e,d,b){var c=this;this.tagged_image=a;this.photo_id=b;this.image_tag=e;this.tagged_obj=d;this.id=f;this.set_html=function(g){this.image_tag.html=g};this.save=function(h){var g={action:"wcpt_designtag_save",img_id:c.tagged_image.data("wcpt_image_id"),img_width:c.tagged_image.width(),img_height:c.tagged_image.height(),tag_x:c.image_tag.pos_x,tag_y:c.image_tag.pos_y,tag_width:c.image_tag.width,tag_height:c.image_tag.height,tag_original:c.image_tag.original,tag_id:c.image_tag.id,tag_description:c.image_tag.description,obj_type:c.tagged_obj.tagged_type,obj_id:c.tagged_obj.id,wcpt_meta_box_nonce:false,obj_var:(c.tagged_obj.tagged_type=="product")?c.tagged_obj.variation_id:""};jQuery.ajax({url:designtag_vars.ajax_url,type:"post",data:g,datatype:JSON,}).done(function(i){return h(i)}).fail(function(j,i,k){alert("There was an error saving the tag: "+i+" : "+k)})};this.fill=function(g){jQuery.ajax({url:designtag_vars.ajax_url,type:"post",data:{action:"wcpt_designtag_fill",id:c.id},datatype:JSON,}).done(function(h){g(h)}).fail(function(i,h,j){alert("There was an error filling the tag: "+h+" : "+j)})}}function get_all_designtags(a,d){var c=[];if(a){a.each(function(){c.push(jQuery(this).data("wcpt_image_id"))});var e=c.join(",");var b={action:"wcpt_get_all_designtags",photo_ids:e,islightbox:d};jQuery.ajax({url:designtag_vars.ajax_url,type:"post",data:b,datatype:JSON,}).done(function(f){tags="";myresult=JSON.parse(f);var g;if(!myresult.no_results){jQuery.each(myresult.tags,function(){jQuery("body").append(this.html)});reset_tags();enable_delete_tag()}else{}}).fail(function(h,g,i,f){console.log("There was an error fetching the tags for "+f+". "+g+" : "+i)})}else{console.log("Designtags: autoload requested but no image_id supplied for "+img.attr("id"))}}function get_designtags(b,d,e){var c=b.data("wcpt_image_id");console.log("doing ajax call for "+b.attr("id"));if(c){var a={action:"wcpt_get_designtags",img_id:c,islightbox:d};jQuery.ajax({url:designtag_vars.ajax_url,type:"post",data:a,datatype:JSON,}).done(function(f){e(f)}).fail(function(h,g,i,f){console.log("There was an error fetching the tags for "+f+". "+g+" : "+i)})}else{console.log("Designtags: autoload requested but no image_id supplied for "+b.attr("id"))}}function render_wcpt(k){if(jQuery(".wcpt_img_"+k.data("tagged_image_id")).length&&!(jQuery(".wcpt_img_"+jQuery(k).data("tagged_image_id")).parents().css("visibility")=="hidden")){var c=jQuery(".wcpt_img_"+k.data("tagged_image_id"));var d=jQuery(c).offset().top+Math.round(parseFloat(k.data("ratio_y"))*parseFloat(c.height())-parseFloat(k.data("tag_height"))/2);var g=d+"px";var f=jQuery(c).offset().left+Math.round(parseFloat(k.data("ratio_x"))*parseFloat(c.width())-parseFloat(k.data("tag_width"))/2);var b=f+"px";var i=(parseFloat(c.height())+parseFloat(c.offset().top))-(d+280);var j=(parseFloat(window.innerWidth)+parseFloat(c.offset().left))-(f+230);var h=j+"px";var e=i+"px";var a=8;if(i<0){k.find("div.ft_msg").css("margin-top",e)}if(j<0){k.find("div.ft_msg").css("margin-left",h)}k.show();k.css({position:"absolute",display:"block",top:g,left:b,"z-index":a})}else{k.hide()}}function delete_designtag(b,c){var a={action:"wcpt_delete_designtag",tag_id:b};jQuery.ajax({url:designtag_vars.ajax_url,type:"post",data:a,datatype:JSON,}).done(function(d){if(d.success){jQuery("li#tag_"+d.tag_id+",li#tag_"+d.tag_id+"_z").fadeOut(200).remove()}c(d)}).fail(function(e,d,f){alert("There was an error while communicating with the server "+d+" : "+f)})}function spin(c){if(c){var a={lines:13,length:14,width:7,radius:21,scale:1,corners:1,color:"#000",opacity:0.25,rotate:0,direction:1,speed:1,trail:60,fps:20,zIndex:2000000000,className:"spinner",top:"50%",left:"50%",shadow:false,hwaccel:false,position:"absolute"};var b=document.getElementById("tag-products-layer");spinner=new Spinner(a).spin(b)}else{spinner.stop()}}function load_tag_button(){var a='<div id="tagtool-tab"><i class="fa fa-tags"></i></div>';jQuery("body").append(a)}function getRandomInt(b,a){return Math.floor(Math.random()*(a-b+1))+b}function remove_tags(){jQuery(".designtag").each(function(){jQuery(this).remove()})}function getUrlParameter(b,a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var d=new RegExp("[\\?&]"+a+"=([^&#]*)");var c=d.exec(b);return c===null?"":decodeURIComponent(c[1].replace(/\+/g," "))};